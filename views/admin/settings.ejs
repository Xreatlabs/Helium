<html <% if (isDarkMode) { %> class="dark" <% } %>>
<head>
  <title><%= settings.name %></title>
  <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
  <script>
    (function() {
      try {
        var ls = localStorage.getItem('darkMode');
        var preferDark = (ls === 'true') || (ls === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (preferDark) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      } catch (e) {}
    })();
  </script>
  <link rel="stylesheet" href="../assets/tailwind.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@popperjs/core@2.10.1/dist/umd/popper.min.js"></script>
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-200" style="font-family: 'Inter', sans-serif;">
  <div>
    <%- include('../components/navigation') %>
    <div class="md:pl-64 flex flex-col flex-1 min-h-screen">
      <main class="flex-1 pb-8">
        <div class="py-6">
          <%- include('../components/darkmode-toggle') %>
          <% /* Skeleton loader, lasts about 0.3s to let the page content load */ %>
          <%- include('../components/skeleton') %>
          <div class="hidden max-w-7xl pt-8 mx-auto px-4 sm:px-6 md:px-8" id="content">
            <!-- Content -->
            <div class="lg:flex lg:items-center lg:justify-between rounded-3xl mb-8">
              <div class="min-w-0 flex-1">
                <div class="flex">
                  <div class="relative">
                    <div class="bg-gray-200 dark:bg-gray-800 rounded-2xl h-11 w-11 text-center flex text-gray-400 dark:text-gray-500">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mt-3 ml-3">
                        <path fill-rule="evenodd" d="M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 4.889c-.02.12-.115.26-.297.348a7.493 7.493 0 0 0-.986.57c-.166.115-.334.126-.45.083L6.3 5.508a1.875 1.875 0 0 0-2.282.819l-.922 1.597a1.875 1.875 0 0 0 .432 2.385l.84.692c.095.078.17.229.154.43a7.598 7.598 0 0 0 0 1.139c.015.2-.059.352-.153.43l-.841.692a1.875 1.875 0 0 0-.432 2.385l.922 1.597a1.875 1.875 0 0 0 2.282.818l1.019-.382c.115-.043.283-.031.45.082.312.214.641.405.985.57.182.088.277.228.297.35l.178 1.071c.151.904.933 1.567 1.85 1.567h1.844c.916 0 1.699-.663 1.85-1.567l.178-1.072c.02-.12.114-.26.297-.349.344-.165.673-.356.985-.57.167-.114.335-.125.45-.082l1.02.382a1.875 1.875 0 0 0 2.28-.819l.923-1.597a1.875 1.875 0 0 0-.432-2.385l-.84-.692c-.095-.078-.17-.229-.154-.43a7.614 7.614 0 0 0 0-1.139c-.016-.2.059-.352.153-.43l.84-.692c.708-.582.891-1.59.433-2.385l-.922-1.597a1.875 1.875 0 0 0-2.282-.818l-1.02.382c-.114.043-.282.031-.449-.083a7.49 7.49 0 0 0-.985-.57c-.183-.087-.277-.227-.297-.348l-.179-1.072a1.875 1.875 0 0 0-1.85-1.567h-1.843ZM12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z" clip-rule="evenodd" />
                      </svg>
                    </div>
                  </div>
                  <div class="relative ml-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 sm:truncate tracking-tight">Settings</h2>
                    <p class="text-xs font-thin text-gray-500 dark:text-gray-400">Update values in your settings.json file.</p>
                  </div>
                </div>
              </div>
            </div>
            <% if (req.query.err && req.query.err !== "none") { %>
            <div class="rounded-3xl bg-gray-200 dark:bg-gray-800 p-8 mb-5">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-md font-medium tracking-tight text-gray-700 dark:text-gray-200">An error was encountered</h3>
                  <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    <p>Error code: <code><%= req.query.err %></code></p>
                  </div>
                </div>
              </div>
            </div>
            <% } %>
            <% if (req.query.err && req.query.err == "none") { %>
            <div class="rounded-3xl bg-white dark:bg-gray-800 p-8 mb-5">
              <div class="flex">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-emerald-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-md font-medium tracking-tight text-gray-700 dark:text-gray-200">Settings update successful!</h3>
                  <div class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                    <p>Your settings.json file has been updated. Depending on the setting you updated, you may need to reboot Helium to apply the changes.</p>
                  </div>
                </div>
              </div>
            </div>
            <% } %>
            <!-- Pterodactyl -->
            <div class="card mt-10 bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-sm">
              <div class="card-body p-6 sm:p-8">
                <h1 class="text-xl font-semibold text-gray-700 dark:text-gray-200 sm:truncate tracking-tight mb-6">Pterodactyl settings</h1>
                <div class="space-y-6">
                  <div>
                    <label for="url" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">
                      URL <span class="text-gray-400 dark:text-gray-500">(hostname only)</span>
                    </label>
                    <input type="text" class="w-full sm:w-3/4 lg:w-1/2 px-4 py-2.5 focus:border-gray-400 dark:focus:border-gray-500 focus:ring-gray-600 dark:focus:ring-gray-500 border border-gray-200 dark:border-gray-700 shadow-sm transition ease-in-out delay-100 text-sm rounded-xl placeholder:text-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-100 bg-gray-50 dark:bg-gray-900" id="url" placeholder="example.com">
                  </div>

                  <div>
                    <label for="key" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">API Key</label>
                    <input type="text" class="w-full sm:w-3/4 lg:w-1/2 px-4 py-2.5 focus:border-gray-400 dark:focus:border-gray-500 focus:ring-gray-600 dark:focus:ring-gray-500 border border-gray-200 dark:border-gray-700 shadow-sm transition ease-in-out delay-100 text-sm rounded-xl placeholder:text-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-100 bg-gray-50 dark:bg-gray-900" id="key" placeholder="plta_xxx">
                  </div>

                  <div class="pt-4">
                    <button onclick="updatePtero()" type="button" class="transition inline-flex items-center rounded-2xl bg-blue-600 dark:bg-blue-600 px-8 py-2.5 text-sm font-medium text-white hover:bg-blue-700 dark:hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 shadow-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                        <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                      </svg>
                      Update Settings
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <script>
              function updatePtero() {
                const urlInput = document.getElementById('url');
                const keyInput = document.getElementById('key');
                const button = event.target.closest('button');

                if (!urlInput.value || !keyInput.value) {
                  alert('Please fill in all fields');
                  return;
                }

                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Updating...';

                /* Update Pterodactyl settings */
                const url = 'https://' + urlInput.value.replace(/^https?:\/\//, '');
                const key = keyInput.value;

                fetch(`/settings/update?setting=pterodactyl.domain&value=${encodeURIComponent(url)}`)
                  .then(response => {
                    if (response.ok) {
                      fetch(`/settings/update?setting=pterodactyl.key&value=${encodeURIComponent(key)}`)
                        .then(response => {
                          if (response.ok) {
                            // Redirect to /settings?err=none if both requests worked
                            window.location.href = '/settings?err=none';
                          } else {
                            throw new Error('Failed to update Pterodactyl key');
                          }
                        })
                        .catch(error => {
                          console.error('Error:', error);
                          alert('Failed to update Pterodactyl settings');
                          button.disabled = false;
                          button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>Update Settings';
                        });
                    } else {
                      throw new Error('Failed to update Pterodactyl domain');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update Pterodactyl settings');
                    button.disabled = false;
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>Update Settings';
                  });
              }
            </script>
            <!-- OAuth2 -->
            <div class="card mt-10 bg-white dark:bg-gray-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-sm">
              <div class="card-body p-6 sm:p-8">
                <h1 class="text-xl font-semibold text-gray-700 dark:text-gray-200 sm:truncate tracking-tight mb-6">OAuth2 settings</h1>
                <div class="space-y-6">
                  <div>
                    <label for="cID" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Client ID</label>
                    <input type="text" class="w-full sm:w-3/4 lg:w-1/2 px-4 py-2.5 focus:border-gray-400 dark:focus:border-gray-500 focus:ring-gray-600 dark:focus:ring-gray-500 border border-gray-200 dark:border-gray-700 shadow-sm transition ease-in-out delay-100 text-sm rounded-xl placeholder:text-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-100 bg-gray-50 dark:bg-gray-900" id="cID" placeholder="Your Discord Client ID">
                  </div>

                  <div>
                    <label for="cSecret" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Client Secret</label>
                    <input type="password" class="w-full sm:w-3/4 lg:w-1/2 px-4 py-2.5 focus:border-gray-400 dark:focus:border-gray-500 focus:ring-gray-600 dark:focus:ring-gray-500 border border-gray-200 dark:border-gray-700 shadow-sm transition ease-in-out delay-100 text-sm rounded-xl placeholder:text-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-100 bg-gray-50 dark:bg-gray-900" id="cSecret" placeholder="Your Discord Client Secret">
                  </div>

                  <div>
                    <label for="callbackUrl" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">
                      Callback URL <span class="text-gray-400 dark:text-gray-500">(hostname only)</span>
                    </label>
                    <input type="text" class="w-full sm:w-3/4 lg:w-1/2 px-4 py-2.5 focus:border-gray-400 dark:focus:border-gray-500 focus:ring-gray-600 dark:focus:ring-gray-500 border border-gray-200 dark:border-gray-700 shadow-sm transition ease-in-out delay-100 text-sm rounded-xl placeholder:text-gray-400 dark:placeholder-gray-500 text-gray-600 dark:text-gray-100 bg-gray-50 dark:bg-gray-900" id="callbackUrl" placeholder="example.com">
                  </div>

                  <div class="pt-4">
                    <button onclick="updateOAuth2()" type="button" class="transition inline-flex items-center rounded-2xl bg-blue-600 dark:bg-blue-600 px-8 py-2.5 text-sm font-medium text-white hover:bg-blue-700 dark:hover:bg-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 shadow-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                        <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                      </svg>
                      Update Settings
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <script>
              function updateOAuth2() {
                const idInput = document.getElementById('cID');
                const secretInput = document.getElementById('cSecret');
                const urlInput = document.getElementById('callbackUrl');
                const button = event.target.closest('button');

                if (!idInput.value || !secretInput.value || !urlInput.value) {
                  alert('Please fill in all fields');
                  return;
                }

                // Disable button and show loading state
                button.disabled = true;
                button.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Updating...';

                /* Update OAuth2 settings */
                const id = idInput.value;
                const secret = secretInput.value;
                const url = 'https://' + urlInput.value.replace(/^https?:\/\//, '').replace('/callback', '');

                fetch(`/settings/update?setting=api.client.oauth2.id&value=${encodeURIComponent(id)}`)
                  .then(response => {
                    if (response.ok) {
                      fetch(`/settings/update?setting=api.client.oauth2.secret&value=${encodeURIComponent(secret)}`)
                        .then(response => {
                          if (response.ok) {
                            fetch(`/settings/update?setting=api.client.oauth2.link&value=${encodeURIComponent(url)}`)
                              .then(response => {
                                if (response.ok) {
                                  // Redirect to /settings?err=none if all requests worked
                                  window.location.href = '/settings?err=none';
                                } else {
                                  throw new Error('Failed to update OAuth2');
                                }
                              })
                              .catch(error => {
                                console.error('Error:', error);
                                alert('Failed to update OAuth2');
                                button.disabled = false;
                                button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>Update Settings';
                              });
                          } else {
                            throw new Error('Failed to update OAuth2');
                          }
                        })
                        .catch(error => {
                          console.error('Error:', error);
                          alert('Failed to update OAuth2');
                          button.disabled = false;
                          button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>Update Settings';
                        });
                    } else {
                      throw new Error('Failed to update OAuth2');
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update OAuth2');
                    button.disabled = false;
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" /></svg>Update Settings';
                  });
              }
            </script>
          </div>
      </main>
      <%- include('../components/footer') %>
    </div>
  </div>
</body>
</html>
